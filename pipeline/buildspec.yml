# This Terraform configuration sets up a test environment with known security issues
version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo "=== Installing Terraform ==="
      - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
      - unzip terraform_1.6.0_linux_amd64.zip
      - mv terraform /usr/local/bin/
      - terraform --version
      - echo "=== Terraform installed successfully ==="

  pre_build:
    commands:
      - echo "=== Pre-build phase started ==="
      - echo "Current directory: $(pwd)"
      - echo "Directory contents:"
      - ls -la
      - echo "=== Navigating to terraform directory ==="
      - cd terraform
      - echo "Terraform directory contents:"
      - ls -la
      - echo "=== Creating terraform.tfvars ==="
      - |
        cat > terraform.tfvars << 'TFVARS'
        project_name = "terraform-conformity-demo-v2"
        conformity_region = "us-east-1"
        github_owner = "adusei2023"
        github_repo = "terraform-conformity-pipeline"
        github_branch = "main"
        aws_region = "us-east-1"
        conformity_api_key = "dummy-will-be-overridden"
        github_token = "dummy-will-be-overridden"
        github_webhook_secret = "dummy-will-be-overridden"
        TFVARS
      - echo "=== terraform.tfvars created ==="
      - cat terraform.tfvars
      - echo "=== Running terraform init ==="
      - terraform init

  build:
    commands:
      - echo "=== Build phase started ==="
      - echo "=== Running terraform validate ==="
      - terraform validate
      - echo "=== Running terraform plan ==="
      - terraform plan -out=tfplan
      - echo "=== Terraform plan completed successfully ==="
      - echo "=== Security scan completed (demo) ==="

  post_build:
    commands:
      - echo "=== Post-build phase ==="
      - echo "Build completed successfully at $(date)"

artifacts:
  files:
    - '**/*'